<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISBN Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: #f9f9f9;
    }
    video {
      width: 100%;
      height: 50vh;
      object-fit: cover;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin-top: 1em;
      font-size: 1em;
    }
    #zoomControl {
      position: absolute;
      right: 1em;
      top: 5em;
      writing-mode: bt-lr;
      transform: rotate(270deg);
      height: 200px;
      display: none;
    }
    button {
      margin: 1em;
      padding: 0.5em 1em;
      font-size: 1em;
    }
    #status {
      margin-top: 0.5em;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Scan ISBN üìö</h2>
  <video id="video" autoplay muted playsinline></video>
  <input type="range" id="zoomControl" min="1" max="5" step="0.1" value="1" />
  <br />
  <button onclick="captureImage()">üì∏ Capture</button>
  <button onclick="manualEntry()">‚úèÔ∏è Manual Entry</button>
  <p id="status">Camera loading...</p>

  <textarea id="isbnText" readonly placeholder="Captured ISBNs will appear here..."></textarea>
  <br />
  <button onclick="sendEmail()">‚úâÔ∏è Send to Email App</button>

  <input type="file" accept="image/*" id="imageInput" style="display:none" onchange="handleFileUpload(event)"/>

  <script>
    const video = document.getElementById("video");
    const zoomControl = document.getElementById("zoomControl");
    const isbnText = document.getElementById("isbnText");
    const imageInput = document.getElementById("imageInput");
    let videoTrack = null;

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment", zoom: 1 } 
        });
        video.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();

        if (capabilities.zoom) {
          zoomControl.min = capabilities.zoom.min;
          zoomControl.max = capabilities.zoom.max;
          zoomControl.step = capabilities.zoom.step || 0.1;
          zoomControl.value = capabilities.zoom.min;
          zoomControl.style.display = "block";

          zoomControl.oninput = () => {
            const zoomLevel = parseFloat(zoomControl.value);
            videoTrack.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
          };
        }
        showStatus("Camera ready");
      } catch (err) {
        console.error(err);
        showStatus("Camera unavailable. Use manual entry.", true);
      }
    }

    function captureImage() {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
      showStatus("Processing...");
      Tesseract.recognize(canvas, 'eng').then(({ data: { text } }) => {
        const found = extractValidISBNs(text);
        if (found.length) {
          found.forEach(isbn => {
            checkOpenLibrary(isbn).then(title => {
              const result = title ? `${isbn}\t${title}` : `${isbn}\tRESCAN`;
              appendISBN(result);
            });
          });
        } else {
          showStatus("No valid ISBN-13 found. Try again or use manual entry.", true);
        }
      });
    }

    function extractValidISBNs(text) {
      const matches = text.match(/\b97[89][\d]{10}\b/g); // strict ISBN-13 match
      return matches ? Array.from(new Set(matches)) : [];
    }

    function appendISBN(entry) {
      if (!isbnText.value.includes(entry)) {
        isbnText.value += (isbnText.value ? "\n" : "") + entry;
      }
    }

    async function checkOpenLibrary(isbn) {
      try {
        const res = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
        const data = await res.json();
        const details = data[`ISBN:${isbn}`];
        return details ? details.title : null;
      } catch {
        return null;
      }
    }

    function sendEmail() {
      const validEntries = isbnText.value
        .split("\n")
        .filter(line => line.includes("\t") && !line.includes("RESCAN"))
        .join("\n");
      const mailto = `mailto:?subject=Scanned ISBNs&body=${encodeURIComponent(validEntries)}`;
      window.location.href = mailto;
    }

    function manualEntry() {
      imageInput.click();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      showStatus("Analyzing image...");
      Tesseract.recognize(file, 'eng').then(({ data: { text } }) => {
        const found = extractValidISBNs(text);
        if (found.length) {
          found.forEach(isbn => {
            checkOpenLibrary(isbn).then(title => {
              const result = title ? `${isbn}\t${title}` : `${isbn}\tRESCAN`;
              appendISBN(result);
            });
          });
        } else {
          showStatus("No valid ISBN-13 found in image.", true);
        }
      });
    }

    function showStatus(msg, isError = false) {
      const status = document.getElementById("status");
      status.innerText = msg;
      status.style.color = isError ? "red" : "green";
    }

    window.onload = initCamera;
  </script>
</body>
</html>