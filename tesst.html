<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISBN Scanner App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f9f9f9; color: #333; }
    h2 { margin-bottom: 0.5rem; }
    #camera { width: 100%; max-height: 50vh; object-fit: contain; background: #000; }
    #manual-entry { display: none; margin-top: 1rem; }
    textarea { width: 100%; height: 120px; margin-top: 0.5rem; resize: none; background: #eee; border: none; padding: 0.5rem; font-size: 1rem; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; margin-right: 0.5rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>ISBN Scanner</h2>
  <video id="camera" autoplay playsinline></video>
  <div>
    <button id="capture-btn">Capture</button>
    <button id="manual-btn">Manual Entry</button>
    <button id="send-btn">Send via Email</button>
  </div>

  <div id="manual-entry">
    <h3>Detected ISBN(s)</h3>
    <textarea id="isbn-output" readonly></textarea>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('camera');
    const captureBtn = document.getElementById('capture-btn');
    const manualBtn = document.getElementById('manual-btn');
    const sendBtn = document.getElementById('send-btn');
    const manualEntry = document.getElementById('manual-entry');
    const isbnOutput = document.getElementById('isbn-output');

    const openLibraryAPI = async (isbn) => {
      try {
        const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
        const data = await response.json();
        return data[`ISBN:${isbn}`]?.title || 'rescan';
      } catch {
        return 'rescan';
      }
    };

    const extractISBNs = (text) => {
      const isbnRegex = /(?:ISBN(?:-13)?:?\s*)?(\b97[89][\d\- ]{10,16}\b|\b\d{9}[\dXx]\b)/g;
      const matches = [...text.matchAll(isbnRegex)].map(m => m[1].replace(/[- ]/g, ''));
      return [...new Set(matches)];
    };

    const showManualEntry = () => {
      manualEntry.style.display = 'block';
    };

    const runOCR = async (imageData) => {
      try {
        const result = await Tesseract.recognize(imageData, 'eng');
        return result.data.text;
      } catch (e) {
        console.error("Tesseract failed, trying server OCR fallback");
        return await runServerOCR(imageData);
      }
    };

    const runServerOCR = async (imageBlob) => {
      // This endpoint should run PaddleOCR or Google Cloud OCR on your backend
      const form = new FormData();
      form.append('file', imageBlob);
      const res = await fetch('/ocr-fallback', { method: 'POST', body: form });
      const json = await res.json();
      return json.text || '';
    };

    const processText = async (text) => {
      const isbns = extractISBNs(text);
      const results = [];
      for (const isbn of isbns) {
        const title = await openLibraryAPI(isbn);
        if (title !== 'rescan') {
          results.push(`${isbn}\t${title}`);
        }
      }
      isbnOutput.value = results.join('\n');
      if (results.length === 0) showManualEntry();
      else showManualEntry();
    };

    const initCamera = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
      } catch (err) {
        console.error('Camera failed, switching to manual');
        showManualEntry();
      }
    };

    const captureImage = () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(async (blob) => {
        const text = await runOCR(blob);
        await processText(text);
      }, 'image/jpeg');
    };

    captureBtn.onclick = () => captureImage();
    manualBtn.onclick = () => showManualEntry();
    sendBtn.onclick = () => {
      const lines = isbnOutput.value.split('\n');
      const validLines = lines.filter(l => !l.includes('rescan'));
      const body = encodeURIComponent(validLines.join('\n'));
      window.location.href = `mailto:?subject=ISBN Submission&body=${body}`;
    };

    window.onload = () => initCamera();
  </script>
</body>
</html>