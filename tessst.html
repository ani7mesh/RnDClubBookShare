<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISBN Scanner</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 1em; background: #f7f7f7; }
    video, canvas { max-width: 100%; margin: 1em 0; }
    #isbnList { width: 100%; height: 150px; margin-top: 1em; font-family: monospace; }
    .status { margin-top: 0.5em; font-weight: bold; }
    button { padding: 10px 20px; font-size: 1em; margin: 10px; }
    .ok { color: green; }
    .err { color: red; }
  </style>
</head>
<body>

<h2>üìö ISBN/Barcode Scanner</h2>

<video id="video" autoplay></video>
<canvas id="canvas" style="display:none;"></canvas>

<br/>
<button id="start">Start Camera</button>
<button id="shutter">üì∏ Capture</button>

<p class="status" id="status"></p>

<textarea id="isbnList" readonly></textarea>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const statusBox = document.getElementById("status");
  const isbnList = document.getElementById("isbnList");
  const detected = new Map();

  const codeReader = new ZXing.BrowserMultiFormatReader();

  function showStatus(msg, isError = false) {
    statusBox.textContent = msg;
    statusBox.className = "status " + (isError ? "err" : "ok");
  }

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      showStatus("Camera started. Ready to scan.");
    } catch (err) {
      showStatus("Camera access failed: " + err.message, true);
    }
  }

  async function captureImage() {
    const width = video.videoWidth;
    const height = video.videoHeight;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, width, height);
    return canvas;
  }

  async function decodeBarcode(canvas) {
    try {
      const result = await codeReader.decodeFromCanvas(canvas);
      return result.text;
    } catch (err) {
      return null;
    }
  }

  function extractISBN(text) {
    const matches = text.match(/97[89][- ]?\d{1,5}[- ]?\d{1,7}[- ]?\d{1,7}[- ]?\d/);
    return matches ? matches[0].replace(/[- ]/g, "") : null;
  }

  async function lookupBookInfo(isbn) {
    try {
      const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
      const data = await res.json();
      if (data.totalItems > 0) {
        const book = data.items[0].volumeInfo;
        return book.title || "Untitled";
      }
    } catch (err) {
      console.error("Lookup failed:", err);
    }
    return null;
  }

  function updateTextarea() {
    let out = "";
    for (const [isbn, title] of detected.entries()) {
      out += `${isbn}\t${title}\n`;
    }
    isbnList.value = out.trim();
  }

  document.getElementById("start").onclick = startCamera;

  document.getElementById("shutter").onclick = async () => {
    showStatus("Capturing...");
    const snap = await captureImage();
    const raw = await decodeBarcode(snap);

    if (!raw) {
      showStatus("No barcode detected. Try again.", true);
      return;
    }

    const isbn = extractISBN(raw);
    if (!isbn) {
      showStatus("No ISBN found. Try again.", true);
      return;
    }

    if (detected.has(isbn)) {
      showStatus("Already scanned this ISBN.", true);
      return;
    }

    showStatus(`ISBN found: ${isbn} ‚Äì Looking up title...`);
    const title = await lookupBookInfo(isbn);
    detected.set(isbn, title || "Rescan");

    updateTextarea();
    showStatus("Book added ‚úîÔ∏è");
  };
</script>

</body>
</html>